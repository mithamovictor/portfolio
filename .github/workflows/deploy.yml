name: Deploy My Portfolio

on:
  push:
    branches: [ main ]

env:
  BASE_DEPLOY_PATH: /home/vic
  APP_NAME: portfolio
  FRONTEND_PORT: 3003
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.16.0

      - name: ‚ö° Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: üì• Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üîí Run pnpm audit
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            pnpm audit --audit-level=high || true
          else
            pnpm audit --audit-level=high
          fi

      - name: üîç Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"

  build:
    needs: security-checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    needs: build
    runs-on: [self-hosted, alma9]

    concurrency:
      group: deploy-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "DEPLOY_PATH=${BASE_DEPLOY_PATH}/${{ github.event.repository.name }}" >> $GITHUB_ENV
          echo "APP_NAME=${APP_NAME}-${{ github.ref_name }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_ENV

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ† Generate environment file
        run: |
          mkdir -p "$DEPLOY_PATH"
          cp .env.example "$DEPLOY_PATH/.env"
          export BREVO_API_KEY_PORTFOLIO='${{ secrets.BREVO_API_KEY_PORTFOLIO }}'
          export DEV_TO_API_KEY_PORTFOLIO='${{ secrets.DEV_TO_API_KEY_PORTFOLIO }}'
          envsubst < "$DEPLOY_PATH/.env" > "$DEPLOY_PATH/.env.tmp" && mv "$DEPLOY_PATH/.env.tmp" "$DEPLOY_PATH/.env"

      - name: üõë Stop and remove old container
        run: |
          docker stop "$APP_NAME" || true
          docker rm -f "$APP_NAME" || true

      - name: üßπ Cleanup dangling images
        run: docker image prune -f --filter "dangling=true"

      - name: üì• Pull and run container
        run: |
          docker pull "$IMAGE_TAG"
          docker run -d \
            --name "$APP_NAME" \
            --restart unless-stopped \
            -p "$FRONTEND_PORT":3000 \
            --env-file "$DEPLOY_PATH/.env" \
            "$IMAGE_TAG"

      - name: ‚úÖ Health check
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:$FRONTEND_PORT > /dev/null 2>&1; then
              echo "Container is healthy"
              exit 0
            fi
            echo "Attempt $i: Waiting for container..."
            sleep 2
          done
          echo "Container failed to start"
          exit 1

      - name: üóëÔ∏è Cleanup deployment directory
        if: always()
        run: |
          rm -rf "$DEPLOY_PATH"
