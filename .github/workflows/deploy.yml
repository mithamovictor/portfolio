name: Deploy My portfolio

on:
  push:
    branches: [ main ]

env:
  BASE_DEPLOY_PATH: /home/vic
  APP_NAME: portfolio
  FRONTEND_PORT: 3003

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ‚ö° Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.16.0

      - name: üì• Install dependencies
        run: pnpm install

      - name: üîí Run pnpm audit
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            pnpm audit --audit-level=high || true
          else
            pnpm audit --audit-level=high
          fi

      - name: üîç Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"

  deploy:
    needs: security-checks
    runs-on: [self-hosted, alma9]

    concurrency:
      group: deploy-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4

      - name: üìÇ Prepare deployment directory
        run: |
          export DEPLOY_PATH="${BASE_DEPLOY_PATH}/${{ github.ref_name }}/${{ github.event.repository.name }}"
          mkdir -p "$DEPLOY_PATH"
          rsync -a --delete ./ "$DEPLOY_PATH/"
          echo "DEPLOY_PATH=$DEPLOY_PATH" >> $GITHUB_ENV

      - name: üõ† Generate environment file
        run: |
          cd "$DEPLOY_PATH"

          cp .env.example .env

          export BREVO_API_KEY_PORTFOLIO='${{ secrets.BREVO_API_KEY_PORTFOLIO }}'
          export DEV_TO_API_KEY_PORTFOLIO='${{ secrets.DEV_TO_API_KEY_PORTFOLIO }}'
          export APP_NAME="${APP_NAME}-${{ github.ref_name }}"

          envsubst < .env > .env.tmp && mv .env.tmp .env

      - name: üõë Stop existing container
        run: |
          docker stop "${APP_NAME}-${{ github.ref_name }}" || true
          docker rm -f "${APP_NAME}-${{ github.ref_name }}" || true

      - name: üßπ Cleanup old images
        run: docker system prune -f

      - name: üèóÔ∏è Build Docker image
        run: |
          cd "$DEPLOY_PATH"
          docker build -t "${APP_NAME}:${{ github.ref_name }}" .

      - name: üöÄ Run container
        run: |
          docker run -d \
            --name "${APP_NAME}-${{ github.ref_name }}" \
            --restart unless-stopped \
            -p ${FRONTEND_PORT}:3000 \
            --env-file "$DEPLOY_PATH/.env" \
            "${APP_NAME}:${{ github.ref_name }}"
