name: Deploy My Portfolio

on:
  push:
    branches: [ main ]

env:
  BASE_DEPLOY_PATH: /home/vic
  APP_NAME: portfolio
  FRONTEND_PORT: 3003

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: âš¡ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.16.0

      - name: ğŸ“¥ Install dependencies
        run: pnpm install

      - name: ğŸ”’ Run pnpm audit
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            pnpm audit --audit-level=high || true
          else
            pnpm audit --audit-level=high
          fi

      - name: ğŸ” Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"

  deploy:
    needs: security-checks
    runs-on: [self-hosted, alma9]

    concurrency:
      group: deploy-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - name: ğŸš€ Checkout repository
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "DEPLOY_PATH=${BASE_DEPLOY_PATH}/${{ github.event.repository.name }}" >> $GITHUB_ENV
          echo "APP_NAME=${APP_NAME}-${{ github.ref_name }}" >> $GITHUB_ENV
          echo "FRONTEND_PORT=${FRONTEND_PORT}" >> $GITHUB_ENV

      - name: ğŸ“‚ Prepare deployment directory
        run: |
          mkdir -p "$DEPLOY_PATH"
          rsync -a --delete ./ "$DEPLOY_PATH/"

      - name: ğŸ›  Generate environment file
        run: |
          cd "$DEPLOY_PATH"
          cp .env.example .env
          export BREVO_API_KEY_PORTFOLIO='${{ secrets.BREVO_API_KEY_PORTFOLIO }}'
          export DEV_TO_API_KEY_PORTFOLIO='${{ secrets.DEV_TO_API_KEY_PORTFOLIO }}'
          envsubst < .env > .env.tmp && mv .env.tmp .env

      - name: ğŸ›‘ Stop existing container
        run: |
          docker stop "$APP_NAME" || true
          docker rm -f "$APP_NAME" || true

      - name: ğŸ§¹ Cleanup old images
        run: docker system prune -f

      - name: ğŸ—ï¸ Build Docker image
        run: |
          cd "$DEPLOY_PATH"
          docker build -t "$APP_NAME" .

      - name: ğŸš€ Run container
        run: |
          docker run -d \
            --name "$APP_NAME" \
            --restart unless-stopped \
            -p "$FRONTEND_PORT":3000 \
            --env-file "$DEPLOY_PATH/.env" \
            "$APP_NAME"

      - name: ğŸ—‘ï¸ Delete deployment directory
        run: |
          rm -rf "$DEPLOY_PATH"
