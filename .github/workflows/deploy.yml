name: Deploy Portfolio to Kubernetes

on:
  push:
    branches: [ main, dev ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NAMESPACE: portfolio
  APP_NAME: portfolio

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.16.0

      - name: âš¡ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”’ Run pnpm audit
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            pnpm audit --audit-level=high || true
          else
            pnpm audit --audit-level=high
          fi

      - name: ğŸ” Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"

  build:
    needs: security-checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    needs: build
    runs-on: [self-hosted, alma9]

    concurrency:
      group: deploy-portfolio-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”§ Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: ğŸ—ï¸ Configure kubectl context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl cluster-info

      - name: ğŸ“ Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: ğŸ” Create environment secret
        run: |
          kubectl create secret generic ${{ env.APP_NAME }}-env \
            --from-literal=BREVO_API_KEY="${{ secrets.BREVO_API_KEY_PORTFOLIO }}" \
            --from-literal=DEV_TO_API_KEY="${{ secrets.DEV_TO_API_KEY_PORTFOLIO }}" \
            -n ${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: ğŸ“¦ Deploy to Kubernetes
        run: |
          kubectl apply -f - <<EOF
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ env.APP_NAME }}-${{ github.ref_name }}
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: ${{ env.APP_NAME }}
              branch: ${{ github.ref_name }}
          spec:
            replicas: 2
            strategy:
              type: RollingUpdate
              rollingUpdate:
                maxSurge: 1
                maxUnavailable: 0
            selector:
              matchLabels:
                app: ${{ env.APP_NAME }}
                branch: ${{ github.ref_name }}
            template:
              metadata:
                labels:
                  app: ${{ env.APP_NAME }}
                  branch: ${{ github.ref_name }}
              spec:
                containers:
                  - name: ${{ env.APP_NAME }}
                    image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                    imagePullPolicy: Always
                    ports:
                      - name: http
                        containerPort: 3000
                    env:
                      - name: BREVO_API_KEY
                        valueFrom:
                          secretKeyRef:
                            name: ${{ env.APP_NAME }}-env
                            key: BREVO_API_KEY
                      - name: DEV_TO_API_KEY
                        valueFrom:
                          secretKeyRef:
                            name: ${{ env.APP_NAME }}-env
                            key: DEV_TO_API_KEY
                      - name: NODE_ENV
                        value: "production"
                    resources:
                      requests:
                        cpu: 100m
                        memory: 256Mi
                      limits:
                        cpu: 500m
                        memory: 512Mi
                    livenessProbe:
                      httpGet:
                        path: /
                        port: http
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3
                    readinessProbe:
                      httpGet:
                        path: /
                        port: http
                      initialDelaySeconds: 10
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 2
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ env.APP_NAME }}-${{ github.ref_name }}
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: ${{ env.APP_NAME }}
              branch: ${{ github.ref_name }}
          spec:
            type: ClusterIP
            selector:
              app: ${{ env.APP_NAME }}
              branch: ${{ github.ref_name }}
            ports:
              - name: http
                port: 3000
                targetPort: http
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: ${{ env.APP_NAME }}-${{ github.ref_name }}
            namespace: ${{ env.NAMESPACE }}
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt-prod
              kubernetes.io/ingress.class: nginx
          spec:
            tls:
              - hosts:
                  - ${{ github.ref_name == 'main' && 'portfolio.mithamo.cc' || 'dev-portfolio.mithamo.cc' }}
                secretName: ${{ env.APP_NAME }}-${{ github.ref_name }}-tls
            rules:
              - host: ${{ github.ref_name == 'main' && 'portfolio.mithamo.cc' || 'dev-portfolio.mithamo.cc' }}
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: ${{ env.APP_NAME }}-${{ github.ref_name }}
                          port:
                            number: 3000
          EOF

      - name: â³ Wait for deployment rollout
        run: |
          kubectl rollout status deployment/${{ env.APP_NAME }}-${{ github.ref_name }} -n ${{ env.NAMESPACE }} --timeout=5m

      - name: âœ… Health check
        run: |
          # Try to get Service IP, but also check if Service exists
          SERVICE_NAME="${{ env.APP_NAME }}-${{ github.ref_name }}"
          SERVICE_IP=$(kubectl get service $SERVICE_NAME -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.clusterIP}' || echo "")

          if [ -z "$SERVICE_IP" ]; then
            echo "âŒ Could not find Service IP for $SERVICE_NAME"
            kubectl get svc -n ${{ env.NAMESPACE }}
            exit 1
          fi

          echo "Checking health at http://$SERVICE_IP:3000"

          # Increase total wait time and add more diagnostics
          for i in {1..20}; do
            echo "Attempt $i: Waiting for application..."
            # Use a temporary pod to curl the service IP
            # We use --quiet to avoid extra kubectl noise, but keep curl verbose on failure
            if kubectl run -n ${{ env.NAMESPACE }} --rm -i --restart=Never curl-check -- curl -v -f "http://$SERVICE_IP:3000" --connect-timeout 5; then
              echo "âœ… Application is healthy"
              exit 0
            fi
            echo "Retrying in 10 seconds..."
            sleep 10
          done

          echo "âŒ Application failed to start or is unreachable after 200 seconds"
          echo "--- POD STATUS ---"
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }},branch=${{ github.ref_name }}

          echo "--- SERVICE DETAILS ---"
          kubectl describe service $SERVICE_NAME -n ${{ env.NAMESPACE }}

          echo "--- ENDPOINTS ---"
          kubectl get endpoints $SERVICE_NAME -n ${{ env.NAMESPACE }}

          echo "--- RECENT POD LOGS ---"
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }},branch=${{ github.ref_name }} -o jsonpath='{.items[0].metadata.name}' || echo "")
          if [ -n "$POD_NAME" ]; then
            kubectl logs $POD_NAME -n ${{ env.NAMESPACE }} --tail=100
          fi
          exit 1

      - name: ğŸ” Deployment status
        if: success()
        run: |
          echo "### Deployment Status"
          kubectl get deployment -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }}
          echo ""
          echo "### Pods"
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }},branch=${{ github.ref_name }} -o wide
          echo ""
          echo "### Services"
          kubectl get svc -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }}
          echo ""
          echo "### Ingress"
          kubectl get ingress -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }}

      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          {
            echo "## ğŸ‰ Portfolio Deployment Successful"
            echo ""
            echo "### Application Details"
            echo "- **App**: ${{ env.APP_NAME }}-${{ github.ref_name }}"
            echo "- **Branch**: ${{ github.ref_name }}"
            echo "- **Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
            echo "- **Namespace**: ${{ env.NAMESPACE }}"
            echo ""
            echo "### Access URLs"
            echo "- **URL**: https://${{ github.ref_name == 'main' && 'portfolio.mithamo.cc' || 'dev-portfolio.mithamo.cc' }}"
            echo ""
            echo "### Kubernetes Resources"
            echo "\`\`\`"
            kubectl get deployment,svc,ingress -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }},branch=${{ github.ref_name }}
            echo "\`\`\`"
            echo ""
            echo "### Pod Status"
            echo "\`\`\`"
            kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }},branch=${{ github.ref_name }} -o wide
            echo "\`\`\`"
          } >> $GITHUB_STEP_SUMMARY
