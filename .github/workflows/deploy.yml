name: Deploy Mediloop frontend

on:
    push:
        branches:
            - main
            - dev

env:
    DEPLOY_PATH: /home/vic/mediloop/${{ github.ref_name }}/${{ github.event.repository.name }}

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            # --- Setup SSH like GitLab's before_script ---
            - name: üöÄ Checkout (for metadata)
              uses: actions/checkout@v4

            - name: üîë Setup SSH agent
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: üì° Add server to known_hosts
              run: |
                  mkdir -p ~/.ssh
                  ssh-keyscan -H ${{ secrets.TARGET_SERVER_HOST }} >> ~/.ssh/known_hosts

            # --- Stage: clone ---
            - name: üîÑ Clone project on server
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.TARGET_SERVER_USER }}@${{ secrets.TARGET_SERVER_HOST }} "
                    if [ ! -d '$DEPLOY_PATH/.git' ]; then
                      echo 'üìÇ Project not found. Cloning...';
                      mkdir -p '$DEPLOY_PATH';
                      git clone --branch ${{ github.ref_name }} git@github.com:${{ github.repository }}.git '$DEPLOY_PATH';
                    else
                      echo '‚úÖ Project already exists. Fetching latest...';
                      cd '$DEPLOY_PATH';
                      git fetch origin;
                    fi
                  "

            # --- Stage: setup ---
            - name: üõ† Setup project on server
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.TARGET_SERVER_USER }}@${{ secrets.TARGET_SERVER_HOST }} "
                    cd '$DEPLOY_PATH'
                    git checkout -B ${{ github.ref_name }} origin/${{ github.ref_name }}
                    git pull origin ${{ github.ref_name }}
                  "

            # --- Stage: build ---
            - name: üèó Build project on server
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.TARGET_SERVER_USER }}@${{ secrets.TARGET_SERVER_HOST }} "
                    cd '$DEPLOY_PATH'
                    pnpm install
                  "

            # --- Stage: deploy ---
            - name: üöÄ Deploy with PM2
              run: |
                  BRANCH=${{ github.ref_name }}
                  FRONTEND_PORT=0
                  if [ "$BRANCH" = "dev" ]; then
                    FRONTEND_PORT=3000
                  elif [ "$BRANCH" = "main" ]; then
                    FRONTEND_PORT=3001
                  fi

                  ssh -o StrictHostKeyChecking=no ${{ secrets.TARGET_SERVER_USER }}@${{ secrets.TARGET_SERVER_HOST }} "
                    cd '$DEPLOY_PATH'

                    export CI_PROJECT_NAME='${{ github.event.repository.name }}'
                    export CI_COMMIT_BRANCH='$BRANCH'
                    export FRONTEND_PORT='$FRONTEND_PORT'

                    pm2 stop \"\$CI_PROJECT_NAME-\$CI_COMMIT_BRANCH\" || true
                    pm2 delete \"\$CI_PROJECT_NAME-\$CI_COMMIT_BRANCH\" || true

                    if [ \"\$CI_COMMIT_BRANCH\" = \"dev\" ]; then
                      echo '‚ñ∂Ô∏è Running pnpm dev...'
                      pm2 start \"pnpm dev -p \$FRONTEND_PORT\" --name \"\$CI_PROJECT_NAME-\$CI_COMMIT_BRANCH\"
                    elif [ \"\$CI_COMMIT_BRANCH\" = \"main\" ]; then
                      echo 'üèó Building and starting app...'
                      pnpm build
                      pm2 start \"pnpm start\" --name \"\$CI_PROJECT_NAME-\$CI_COMMIT_BRANCH\"
                    fi

                    pm2 save
                  "